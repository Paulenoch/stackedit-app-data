# 一、整体思想（一句话）

把**抽奖次数**当成一种**商品（SKU）**来卖/发放：  
谁想要次数，就**对活动的某个 SKU 下单**；订单=流水，到账后把次数**充**进用户的账户里；抽奖时再从账户里**扣**。

----------

# 二、都有哪些表？各自管啥？

## 1）抽奖活动表（活动的“海报”）

**只存活动本身的信息**，不再管库存、参与配置。

-   你能在这张表里看到：活动 ID、名称、描述、开始/结束时间、抽奖策略、状态、创建/更新时间。
    
-   记住：**它不再“背库存”**，库存搬去 SKU 了。
    

> 理解：这就是活动的“宣传页+开关”。活动什么时候开、用什么策略抽，来这张表看。

----------

## 2）参与次数表（“套餐规格表”）

**定义一次下单能拿到多少次数**，相当于套餐规格。

-   关键字段（白话）：**次数编号**、**总次数**、**日次数**、**月次数**。
    
-   作用：SKU 会引用这张表，表示“这个 SKU 送（或卖）几次、日/月各加多少”。
    

> 理解：就像买流量包：1 次、3 次、5 次、10 次……这些“包”的规格在这儿。

----------

## 3）活动 SKU 表（真正的“商品”）

**把“活动 + 套餐规格（次数编号）”组合成一个可下单的 SKU**，并且**这里才有库存**。

-   关键字段（白话）：**SKU 编码**、**活动 ID**、**次数编号**、**库存总量**、**库存剩余**（以及状态/时间戳等常见字段）。
    
-   用处：
    
    -   一个活动可以有多个 SKU（比如 1 次、3 次、10 次包）。
        
    -   后续要加价格、积分消耗、会员价等，也都在 SKU 维度加即可。
        
    -   有些活动想要“限量发放”就靠这里的库存。
        

> 理解：SKU 就是“在活动 A 下的 5 次抽奖包（限量 1000 份）”。

----------

## 4）活动下单记录（所有拿次数的来源都在这）

**统一记录用户是怎么获得次数的——都算“下了一笔订单”。**

-   关键字段（白话）：**用户 ID、活动 ID、SKU、订单 ID/状态、下单时间、获得的总/日/月次数、唯一幂等键**（用来防止重复发放）、创建/更新时间。
    
-   场景全覆盖：
    
    -   购买：正常付费下单。
        
    -   签到/打卡/任务奖励/积分兑换/运营补偿：都会生成**0 元或特殊来源**的订单。
        
-   这张表就是**你要的“流水”**，原来的“次数流水表”被它替代了。
    

> 理解：不管你是花钱买的，还是签到送的，本质都是“给你开了一张订单，订单的内容是：X 次抽奖”。

----------

## 5）活动次数账户（用户的“次数钱包”）

**按“用户 × 活动”维度，维护次数余额。**

-   关键字段（白话）：**用户 ID、活动 ID、总次数/总剩余、日剩余、月剩余、创建/更新时间**。
    
-   入账/扣减规则：
    
    -   **订单成功** → 按对应的套餐把次数**充入**账户。
        
    -   **用户抽一次** → 从账户里**扣 1**（并按日/月口径同步扣）。
        
    -   日/月的额度按你的业务规则**重置**（例如每天 0 点清日额、每月 1 号清月额）。
        

> 理解：这就是“话费余额”。你充多少、花多少，全在这张表里体现。

----------

# 三、它们之间怎么配合（一步步走）

1.  **活动发布**  
    先在“活动表”开活动 → 给活动配置若干“套餐规格”（1 次/5 次/10 次……）→ 把“活动 + 套餐规格”组合成多个 **SKU**（并设置库存、是否限量等）。
    
2.  **用户获取次数（统一走下单）**
    
    -   购买：用户直接对目标 **SKU** 下单并支付。
        
    -   签到/打卡/任务奖励/积分兑换/运营补偿：系统给用户**创建一笔 0 元（或积分）订单**，来源标识写清楚。
        
    -   订单成功后：
        
        1.  **扣 SKU 库存**（如有限量）；
            
        2.  按“次数编号”的规格，给用户的**活动次数账户**加上对应的总/日/月次数；
            
        3.  “活动下单记录”完整记账（就是你要的流水）。
            
3.  **用户抽奖**
    
    -   校验活动是否在有效期、状态是否可抽。
        
    -   校验“活动次数账户”是否还有可用次数（含日/月口径）。
        
    -   通过后，账户**扣 1 次**，然后走抽奖逻辑产出结果。
        

> 小重点：**“扣库存、记订单、加次数到账”**建议放在**同一个事务/消息链路**里做**幂等**（靠“唯一幂等键”，例如 user_id+activity_id+来源业务 id），防止重复发放或扣多了。

----------

# 四、为什么这么改更爽？

-   **活动变轻**：活动只管“什么时候开”“怎么抽”，**库存/价格/次数规格**都放到 SKU。
    
-   **发放统一**：任何来源都走“下单→到账”，**订单即流水**，审计清晰。
    
-   **扩展随手加**：以后想开“积分兑换”“会员专享价”“限量抢购”，都只是在 **SKU** 上加字段或多配一个 SKU。
    
-   **防重好做**：有了“唯一幂等键”，同一笔赠送/回调就算来两次也只记一笔。
    

----------

# 五、几个落地细节（实操建议）

-   **不限量库存**：可以用 `stock_total = -1` 或 `NULL` 表示“无限量”，判断时跳过扣减。
    
-   **索引/唯一键**：
    
    -   账户表：`(user_id, activity_id)` 唯一；
        
    -   SKU 表：`(activity_id, status)`、`sku` 唯一；
        
    -   下单记录：建议有 `unique_key`（如 `user_id + activity_id + biz_id`）防止重复入账。
        
-   **计费多形态**：在订单或 SKU 上放 `pay_type`（现金/积分/券抵扣/0 元），后续对账清楚。
    
-   **日/月额度重置**：用定时任务或结算表记录“上次重置时间”，避免跨天/月统计错位。
    

----------

# 六、把它再翻成“生活比喻版”

-   **活动表**：活动海报+开关。
    
-   **参与次数表**：1 次/3 次/5 次的“流量包规格”。
    
-   **活动 SKU 表**：真正挂在货架上的“流量包商品”（还能限量）。
    
-   **活动下单记录**：每次你买/送到的“收据”。
    
-   **活动次数账户**：你的“余额”。抽一次就扣一格，到账就加几格。
<!--stackedit_data:
eyJoaXN0b3J5IjpbLTE5NTY2MDcwMl19
-->