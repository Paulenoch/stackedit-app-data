## 2. 方案详解

### 2.1. 整体评估流程

对于每一个需要评估准确率的元数据描述项（例如 `table_desc`），系统将执行以下流程：

1.  **检查覆盖率**：首先确认该描述字段是否已填写。若未填写，则准确率评估结束，计为覆盖率问题。
    
2.  **执行启发式预检**：
    
    -   若描述内容命中任意一条启发式规则（如长度过短），则**直接判定为低分**（例如：10分），并生成一条标准化的优化建议（例如：“描述内容过于简单，请补充详细信息”）。流程终止。
        
    -   若所有启发式规则均通过，则进入下一步。
        
3.  **构建LLM评估上下文**：收集与当前描述相关的所有元数据，组装成一个结构化的上下文对象。
    
4.  **调用LLM服务**：将上下文对象格式化为一个精心设计的Prompt，异步调用LLM API。
    
5.  **解析并存储结果**：解析LLM返回的结构化数据（JSON），提取准确率得分 (`score`) 和优化建议 (`suggestion`)。
    
6.  **聚合与报告**：在遍历完所有评估项后，聚合所有得分，形成最终报告。
### 2.2. 启发式规则集

以下规则将在调用LLM之前执行，用于拦截低级错误：

-   **规则1：长度下限**
    
    -   **逻辑**：`len(description.strip()) < 5`
        
    -   **说明**：描述内容去除首尾空格后，长度少于5个字符。这通常意味着描述无效或只是敷衍填写。
        
-   **规则2：内容与名称重复**
    
    -   **逻辑**：`description.strip().lower() == field_name.lower()` 或 `description.strip() == field_business_name`
        
    -   **说明**：描述内容与字段的物理名称或业务名称完全一样，没有提供任何增量信息。
        
-   **规则3：通用无效词**
    
    -   **逻辑**：`description.strip() in ["字段", "描述", "测试", "test"]`
        
    -   **说明**：描述为无意义的通用词汇。

### 2.3. LLM 语义评估 — 核心设计

这是本方案的核心。LLM评估的质量直接取决于我们提供给它的**上下文质量**和**指令清晰度**。

#### 2.3.1. Prompt 设计五大原则

1.  **角色扮演 (Role-Playing)**
    
    -   **目的**：为LLM设定一个专家身份，引导其以专业的视角和口吻进行输出。
        
    -   **指令**：`"你是一位资深的数据治理专家和数据架构师..."`
        
2.  **任务定义 (Task Definition)**
    
    -   **目的**：清晰、无歧义地告知LLM需要完成的具体任务。
        
    -   **指令**：`"...你的任务是根据我提供的元数据上下文，严格评估'待评估描述'的质量。请完成以下两件事：1. 给出一个0到100之间的整数准确率得分。2. 如果得分低于90分，请生成一条不超过50字的、更专业和清晰的'优化建议'。"`
        
3.  **上下文注入 (Context Injection)**
    
    -   **目的**：提供足够丰富、结构化的信息，作为LLM评估的依据。这是最关键的一步。
        
    -   **实现**：
        
        -   **评估字段描述时**：
            
            ```
            {
              "metadata_context": {
                "table_name": "dim_user_order_detail",
                "table_description": "用户订单明细事实表，记录了每个订单包含的具体商品信息。",
                "field_name": "is_present",
                "field_business_name": "是否为赠品",
                "data_type": "boolean"
              },
              "description_to_assess": "是否赠送"
            }
            ```
            
        -   **评估表描述时**：
            
            ```
            {
              "metadata_context": {
                "table_name": "dim_user_order_detail",
                "fields": [
                  {"name": "order_id", "business_name": "订单ID"},
                  {"name": "product_id", "business_name": "商品ID"},
                  {"name": "price", "business_name": "成交单价"},
                  {"name": "is_present", "business_name": "是否为赠品"}
                ]
              },
              "description_to_assess": "用户的订单"
            }
            ```
            
4.  **评估标准定义 (Criteria Definition) - [已优化]**
    
    -   **目的**：为LLM提供一个**极其详细和结构化**的评分标准，使其判断有据可依，结果更精准、更符合预期。
        
    -   **指令**：`"请基于以下针对不同元数据类型的**详细评分标准**进行打分：\n\n**A. 如果评估的是'表描述' (table_desc)，请考察：**\n - **1. 定义与范围 (满分40)**：是否清晰定义了表的业务用途、核心内容和数据范围？\n - **2. 关联关系 (满分30)**：是否说明了与其它核心表的关联方式（例如：通过哪个Key Join）？\n - **3. 使用方法 (满分30)**：是否提供了具体的使用场景、注意事项或查询示例？\n\n**B. 如果评估的是'字段描述' (field_desc)，请考察：**\n - **1. 核心含义 (满分40)**：是否清晰、无歧义地解释了字段的业务含义？\n - **2. 格式与单位 (满分30)**：对于时间、货币等字段，是否说明了其具体格式（如'yyyyMMdd'）和单位（如'元'）？若不适用则此项为满分。\n - **3. 枚举值解释 (满分30)**：对于状态、类型等字段，是否列举了所有可能的枚举值及其含义？若不适用则此项为满分。\n\n**C. 通用要求：** 描述语言是否专业、精炼？"`
        
5.  **结构化输出要求 (Structured Output Enforcement)**
    
    -   **目的**：强制LLM返回可被程序直接解析的JSON格式，避免处理不稳定的自然语言。
        
    -   **指令**：`"请严格按照以下JSON格式返回，不要包含任何额外的解释或Markdown标记：\n{\"score\": <你的总打分>, \"suggestion\": \"<你的建议>\"}"`
        

#### 2.3.2. 完整 Prompt 示例 [已优化]

将以上原则组合起来，形成一个完整的API请求内容。System Prompt部分已根据新的评估标准进行重写。

```
POST /llm-api/v1/chat/completions
{
  "model": "gemini-pro", // 或其他可用模型
  "temperature": 0.2, // 使用较低的温度以获得更稳定的输出
  "response_format": { "type": "json_object" }, // 如果API支持，强制JSON输出
  "messages": [
    {
      "role": "system",
      "content": "你是一位资深的数据治理专家和数据架构师。你的任务是根据我提供的元数据上下文，严格评估'待评估描述'的质量。请完成以下两件事：1. 给出一个0到100之间的整数准确率得分。2. 如果得分低于90分，请生成一条不超过50字的、更专业和清晰的'优化建议'。\n\n请严格遵循以下评分标准：\n**A. 如果评估的是'表描述' (table_desc)，请考察：**\n  - **1. 定义与范围 (满分40)**：是否清晰定义了表的业务用途、核心内容和数据范围？\n  - **2. 关联关系 (满分30)**：是否说明了与其它核心表的关联方式（例如：通过哪个Key Join）？\n  - **3. 使用方法 (满分30)**：是否提供了具体的使用场景、注意事项或查询示例？\n\n**B. 如果评估的是'字段描述' (field_desc)，请考察：**\n  - **1. 核心含义 (满分40)**：是否清晰、无歧义地解释了字段的业务含义？\n  - **2. 格式与单位 (满分30)**：对于时间、货币等字段，是否说明了其具体格式（如'yyyyMMdd'）和单位（如'元'）？若不适用则此项为满分。\n  - **3. 枚举值解释 (满分30)**：对于状态、类型等字段，是否列举了所有可能的枚举值及其含义？若不适用则此项为满分。\n\n**C. 通用要求：** 描述语言是否专业、精炼？\n\n请严格按照以下JSON格式返回，不要包含任何额外的解释或Markdown标记：\n{\"score\": <整数总分>, \"suggestion\": \"<优化建议或空字符串>\"}"
    },
    {
      "role": "user",
      "content": "{\"metadata_context\": {\"table_name\": \"dim_user_order_detail\", \"table_description\": \"用户订单明细事实表，记录了每个订单包含的具体商品信息。\", \"field_name\": \"is_present\", \"field_business_name\": \"是否为赠品\", \"data_type\": \"boolean\"}, \"description_to_assess\": \"是否赠送\"}"
    }
  ]
}
```

**预期返回 (Example Response):**

```
{
  "score": 65,
  "suggestion": "核心含义基本正确但不够完整，建议明确布尔值的含义，如：'标识该商品是否为订单赠品，1/true是，0/false否。'"
}
```
<!--stackedit_data:
eyJoaXN0b3J5IjpbMTMwMTE1NzQyMSwtMTMzODE5MTU3NSwxNT
Y1NzI2MzAwLC0xMjU3NDU5ODQ3LDE4MjY1NDU4OTcsNzI1MjM3
MjcsLTIwODg3NDY2MTIsLTIyMjEzNTM1LC0xNzU0NTUxNzQ1XX
0=
-->