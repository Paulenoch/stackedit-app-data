# V3.0 负载均衡
在之前的版本中，当客户端请求服务时，取 从注册中心返回的服务地址列表中的第一个 作为访问的地址

这样做是明显存在问题的，当请求量过大时，单节点会无法承载庞大的流量从而崩溃。

所以在一些流量较大的服务上，我设置多个节点服务器处理请求，并使用负载均衡的思想 将请求分摊到每个节点上

## 常见负载均衡算法
1. 轮询法
2. 随机法
3. 一致性哈希法
 -   **原理**：一致性哈希法将输入（如客户端IP地址）通过哈希函数映射到一个固定大小的环形空间（哈希环）上，每个服务器也映射到这个哈希环上。客户端的请求会根据哈希值在哈希环上顺时针查找，遇到的第一个服务器就是该请求的目标服务器。
    

-   **优点**
    
    -   当服务器数量发生变化时，只有少数键需要被重新映射到新的服务器上，这大大减少了缓存失效的数量，提高了系统的可用性。
        
    
    -   具有良好的可扩展性，可以动态地添加或删除服务器。
        
    

-   **缺点**
    
    -   在哈希环偏斜的情况下，大部分的缓存对象很有可能会缓存到一台服务器上，导致缓存分布极度不均匀。
        
    
    -   实现较为复杂，需要引入虚拟节点等技术来解决哈希偏斜问题。
    - “虚拟节点”就是真实节点的复制品，一个真实的节点对应多个“虚拟节点”，这样使得我们的节点能尽可能的在环形Hash空间均匀分布，这样我们再根据虚拟节点找到真实节点，从而保证每个真实节点上分配到的请求是均衡的。

	- 没有虚拟节点的情况下，节点的增加或删除会导致哈希环上的重新分配，可能导致大量的请求重定向到其他节点，引入虚拟节点后，节点的增删只会影响与该节点相关的少部分虚拟节点，减少了请求的迁移
	- 如果一个真实节点故障且没有虚拟节点，所有映射到该节点的请求都会丢失，引入虚拟节点后，其他的虚拟节点可能会分摊其负载，减少系统的影响

### 为什么使用treeMap存储虚拟节点
TreeMap会根据键的顺序自动进行排序，使用TreeMap存储哈希值与虚拟节点之间的映射shi
<!--stackedit_data:
eyJoaXN0b3J5IjpbMTM0MzM1NjExMCwzMTQ3MTkwMjQsMjEwNj
EzNjE0OCwtNDQ5NTcxODUyLC0yMDg4NzQ2NjEyXX0=
-->