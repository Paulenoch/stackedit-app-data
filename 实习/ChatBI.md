![输入图片说明](/imgs/2025-05-27/puGpXaHAxQ6ai6Hf.png)
### 主要流程说明

#### 1. **获取数据库表与元数据**

-   **智能交互前端** 向 **数据查询组件** 发起请求，获取所有表名。
    
    -   数据查询组件返回所有表名。
        
-   智能交互前端指定某表，查询其元数据。
    
    -   数据查询组件返回表的元数据（字段等）。
        

#### 2. **知识生成与发布**

-   智能交互前端指定表和个人知识类别（如：从PG中生成或获取知识，走RAG/外部知识），并发起知识生成请求给**知识生成组件**。
    
-   知识生成组件返回知识块ID，并将知识块和知识块内容存储到PG。
    
-   智能交互前端可以并行（par）指定多个类别知识块或批量指定类型，批量发布知识。
    
-   知识生成组件同样返回知识块ID，并存储所有知识块和内容到PG。
    

#### 3. **外部知识导入**

-   智能交互前端并行（par）向**外部系统**发起知识导入请求。
    
-   外部系统导入知识，返回SUCCESS。
    

#### 4. **知识库配置管理**

-   智能交互前端获取知识库配置（如top_k、阈值等）。
    
    -   知识生成组件返回配置。
        
-   可以对知识库配置进行修改，知识生成组件返回SUCCESS。
    

#### 5. **示例模板配置管理**

-   智能交互前端获取提示示例模板配置。
    
    -   知识生成组件返回模板配置。
        
-   可以对示例模板配置进行修改，知识生成组件返回SUCCESS。
    

#### 6. **SQL生成与执行**

-   智能交互前端通过用户输入、筛选内容类型、指定执行指标（开发态、运行态），传给**text2sql组件**。
    
-   text2sql组件根据领域或者数据库表和知识，生成SQL。
    
-   生成的SQL被返回到智能交互前端。
    
-   智能交互前端请求**数据查询组件**执行SQL。
    
    -   数据查询组件返回SQL执行结果和数据。


## 基于模板生成SQL
![输入图片说明](/imgs/2025-05-27/cwxTpnqi2cx1e8g0.png)
### 流程详解

1.  **样例问题检索**
    
    -   系统首先会根据用户输入，去知识库里检索最相近的“样例问题”。
        
    -   用到的技术包括：关键词检索、向量检索、置信度设置等。
        
2.  **样例模板参数提取**
    
    -   找到合适的样例问题后，系统会抽取用户输入中的参数（比如日期、产品名、地区等）。
        
    -   并将这些参数映射到SQL模板需要的变量上。
        
3.  **SQL模板参数替换**
    
    -   用前面提取到的参数替换掉SQL模板中的占位符，形成完整的SQL语句。
        
4.  **输出SQL语句**
    
    -   最终生成标准的SQL语句，可以直接用于数据库查询。
 

## 基于表模型生成SQL
### 1. 知识库

-   **关系库中的表信息**  
    存储所有业务表、字段、数据模型等元数据信息。
    
-   **业务元素映射与知识**  
    包含了业务术语和数据库字段/表的对应关系、计算公式、规则等。
    

----------

### 2. 流程步骤

### 1）**问题中术语替换**

-   对用户输入中的业务术语进行标准化处理，如同义词归一、业务专有名词转成标准字段名。
    
-   利用：术语召回、关键词查找、模型智能替换等技术。
    

### 2）**表召回**

-   识别用户问题涉及哪些表，从知识库中找到相关的表模型。
    
-   技术：关键词检索、向量检索。
    

### 3）**字段召回**

-   从表模型中找到具体涉及的字段（比如“销售额”、“订单数”等）。
    
-   技术：关键词检索、向量检索。
    

### 4）**术语（计算公式）召回**

-   若问题涉及业务计算指标（如“增长率”、“同比”），检索相应的计算公式。
    
-   技术：关键词检索、向量检索。
    

### 5）**计算规则召回**

-   针对复杂查询（如分组、过滤、聚合等）检索出相关业务规则。
    
-   技术：关键词检索、向量检索。
    

### 6）**样例SQL召回**

-   检索最贴合本次查询需求的SQL模板（如类似业务问题的SQL样例）。
    
-   技术：关键词检索、向量检索。
    

### 7）**SQL生成**

-   依据上面召回的表、字段、公式、规则和样例SQL，通过模板拼装或大模型推理，生成最终SQL语句。
    

### 8）**输出SQL语句**

-   生成并返回标准SQL，可直接用于数据库查询。


## 基于指标体系生成SQL
### 一、知识库部分

-   **维度/度量/指标知识库**  
    存储所有可用的业务维度、度量、指标的元信息和定义。
    
-   **业务表与指标映射**  
    存储业务指标与数据表、字段的对应关系，支撑自动化映射。
    

----------

### 二、流程详解

### 1. **问题格式化实体抽取**

-   首步对用户的自然语言问题进行格式化，抽取出时间、维度、指标、筛选条件等实体。
    
-   支持：时间实体、维度实体、指标实体、筛选/限定条件。
    
-   示例：  
    问题：“今年每个月所有小汽车销量”  
    抽取实体：时间=今年，维度=月份，指标=销量，限定=小汽车
    

### 2. **实体格式化**

-   对抽取出的实体进行标准化和统一表达，便于后续流程调用。
    
-   对复杂实体做键值对（kv）结构处理，如“销量 + 指标实体kv”。
    

### 3. **维度召回**

-   从知识库召回对应的**维度名**（如“月份”、“车型”）。
    
-   包含：维度名召回、维度名过滤和选择。
    

### 4. **维度过滤/选择/映射**

-   支持对多候选维度进行筛选，确保最终选择的维度与表、字段映射一致。
    
-   包括维度过滤、维度选择、维度过滤条件定义等。
    

### 5. **维度过滤条件转换**

-   针对时间、类别等维度，完成筛选条件的解析与转换（如“今年”→“2024-01-01~2024-12-31”）。
    
-   包括时间区间转换等。
    

### 6. **表召回**

-   基于抽取的实体、维度、指标，召回业务表。
    
-   技术：关键词检索、向量检索等。
    

### 7. **样例sql召回**

-   找到与当前问题结构和实体最匹配的样例SQL模板，作为生成SQL的骨架。
    

### 8. **SQL生成**

-   根据上述所有已确定的表、维度、指标、筛选条件、样例SQL等内容，生成最终SQL语句。
    

### 9. **输出SQL语句**

-   返回标准SQL，供数据库执行。


![输入图片说明](/imgs/2025-05-27/DOXRMpFG48qSeVhX.png)
<!--stackedit_data:
eyJoaXN0b3J5IjpbLTIxOTA4NDY1OCwxODEzODg3OTY2LC0xMT
U0MTcwNTcxLDI4NDE0NTA5LC0yMDgzMDg1OTM4LC0yMDg4NzQ2
NjEyXX0=
-->