# 数据库设计文档 (core_db)

## 1. 目标与范围

本数据库（core_db）旨在支撑“文章写作/协作/阅读平台”的核心业务。涵盖用户账户体系、邮箱验证流程、团队协作机制、社交关注关系、文章内容管理、评论系统以及基于评分的热度分发体系。

## 2. 命名与类型规范

-   **数据库名**：`core_db`
    
-   **表名规范**：使用 `*_tab` 后缀（如 `user_tab`）。
    
-   **字段名规范**：全小写，使用下划线分隔。
    
-   **索引名规范**：以 `idx_` 开头。
    
-   **字符集**：`utf8mb4`，校对规则为 `utf8mb4_unicode_ci`。
    
-   **主键**：统一使用 `BIGINT UNSIGNED AUTO_INCREMENT`。
    
-   **时间字段**：使用 `INT UNSIGNED` 存储 Unix 时间戳（秒级）。
    
-   **外键**：不使用物理外键，逻辑关系由应用层维护。
    

## 3. 表清单与用途概览

**表名**

**用途**

**关键约束/索引说明**

`user_tab`

用户基础信息

`email` 唯一索引

`user_verify_token_tab`

注册验证 Token

`token` 唯一索引，支持过期检查

`team_tab`

团队基本信息

`name` 唯一索引

`team_member_tab`

团队成员关系

`user_id` 唯一（限制用户仅属一个团队）

`user_follow_user_tab`

用户社交关注

`(user_id, target_user_id)` 联合唯一

`user_follow_team_tab`

用户团队关注

`(user_id, team_id)` 联合唯一

`article_tab`

文章内容与统计冗余

包含评分均值与评论数冗余字段

`article_comment_tab`

文章评论记录

支持按文章 ID 分页查询

`article_rating_tab`

文章评分记录

`(article_id, user_id)` 联合唯一

## 4. 字段字典 (核心表)

### 4.1 user_tab (用户表)

**字段**

**类型**

**说明**

`id`

BIGINT UNSIGNED

用户唯一标识 (PK)

`email`

VARCHAR(255)

用户邮箱 (Unique)

`status`

TINYINT UNSIGNED

0:未验证, 1:已激活, 2:禁用

`created_at`

INT UNSIGNED

注册时间戳

### 4.2 article_tab (文章表)

**字段**

**类型**

**说明**

`id`

BIGINT UNSIGNED

文章唯一标识 (PK)

`team_id`

BIGINT UNSIGNED

所属团队ID (0表示个人文章)

`score_avg_x100`

SMALLINT UNSIGNED

评分均值*100 (0-500)，用于高效排序

`created_at`

INT UNSIGNED

发布时间，用于首页 Feed 排序

## 5. DDL（SQL 声明）

```
CREATE DATABASE IF NOT EXISTS `core_db` DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;
USE `core_db`;

-- 用户表
CREATE TABLE `user_tab` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `email` VARCHAR(255) NOT NULL COMMENT 'lowercase email',
  `password_hash` VARCHAR(255) NOT NULL COMMENT 'bcrypt/argon2',
  `status` TINYINT UNSIGNED NOT NULL DEFAULT 0 COMMENT '0:pending, 1:active, 2:disabled',
  `created_at` INT UNSIGNED NOT NULL DEFAULT 0,
  `updated_at` INT UNSIGNED NOT NULL DEFAULT 0,
  `last_login_at` INT UNSIGNED NOT NULL DEFAULT 0,
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_email` (`email`),
  KEY `idx_status_created_at` (`status`, `created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='users';

-- 邮箱验证 Token 表
CREATE TABLE `user_verify_token_tab` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `user_id` BIGINT UNSIGNED NOT NULL,
  `token` VARCHAR(64) NOT NULL,
  `expired_at` INT UNSIGNED NOT NULL DEFAULT 0,
  `used_at` INT UNSIGNED NOT NULL DEFAULT 0,
  `created_at` INT UNSIGNED NOT NULL DEFAULT 0,
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_token` (`token`),
  KEY `idx_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='verify tokens';

-- 团队表
CREATE TABLE `team_tab` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `name` VARCHAR(64) NOT NULL,
  `description` VARCHAR(1024) NOT NULL DEFAULT '',
  `creator_user_id` BIGINT UNSIGNED NOT NULL,
  `created_at` INT UNSIGNED NOT NULL DEFAULT 0,
  `updated_at` INT UNSIGNED NOT NULL DEFAULT 0,
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_team_name` (`name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='teams';

-- 团队成员表 (约束：一个用户最多属于一个团队)
CREATE TABLE `team_member_tab` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `team_id` BIGINT UNSIGNED NOT NULL,
  `user_id` BIGINT UNSIGNED NOT NULL,
  `role` TINYINT UNSIGNED NOT NULL DEFAULT 2 COMMENT '1:owner, 2:member',
  `joined_at` INT UNSIGNED NOT NULL DEFAULT 0,
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_user_id` (`user_id`),
  UNIQUE KEY `idx_team_user` (`team_id`, `user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='team members';

-- 用户关注用户表
CREATE TABLE `user_follow_user_tab` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT 'follower',
  `target_user_id` BIGINT UNSIGNED NOT NULL COMMENT 'followee',
  `created_at` INT UNSIGNED NOT NULL DEFAULT 0,
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_u_t` (`user_id`, `target_user_id`),
  KEY `idx_target` (`target_user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 文章表
CREATE TABLE `article_tab` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `title` VARCHAR(255) NOT NULL,
  `content` MEDIUMTEXT NOT NULL,
  `author_user_id` BIGINT UNSIGNED NOT NULL,
  `team_id` BIGINT UNSIGNED NOT NULL DEFAULT 0 COMMENT '0: personal',
  `status` TINYINT UNSIGNED NOT NULL DEFAULT 1 COMMENT '1:active, 2:deleted',
  `score_sum` INT UNSIGNED NOT NULL DEFAULT 0,
  `score_count` INT UNSIGNED NOT NULL DEFAULT 0,
  `score_avg_x100` SMALLINT UNSIGNED NOT NULL DEFAULT 0 COMMENT '0-500',
  `comment_count` INT UNSIGNED NOT NULL DEFAULT 0,
  `created_at` INT UNSIGNED NOT NULL DEFAULT 0,
  `updated_at` INT UNSIGNED NOT NULL DEFAULT 0,
  PRIMARY KEY (`id`),
  KEY `idx_author_time` (`author_user_id`, `created_at`),
  KEY `idx_team_time` (`team_id`, `created_at`),
  KEY `idx_random_filter` (`created_at`, `score_avg_x100`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 评论表
CREATE TABLE `article_comment_tab` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `article_id` BIGINT UNSIGNED NOT NULL,
  `user_id` BIGINT UNSIGNED NOT NULL,
  `content` TEXT NOT NULL,
  `created_at` INT UNSIGNED NOT NULL DEFAULT 0,
  PRIMARY KEY (`id`),
  KEY `idx_article_time` (`article_id`, `created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- 评分表
CREATE TABLE `article_rating_tab` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `article_id` BIGINT UNSIGNED NOT NULL,
  `user_id` BIGINT UNSIGNED NOT NULL,
  `score` TINYINT UNSIGNED NOT NULL COMMENT '1-5',
  `created_at` INT UNSIGNED NOT NULL DEFAULT 0,
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_art_user` (`article_id`, `user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

## 6. 索引设计与查询建议

1.  **邮箱前缀搜索**：`idx_email` 支持 `LIKE 'abc%'` 查询。
    
2.  **随机推荐过滤**：`idx_random_filter` 支持 `WHERE created_at > (now - 3days) AND score_avg_x100 > 300`。
    
3.  **首页 Feed**：应用层通过关注列表获取 `author_user_ids` 和 `team_ids`，利用 `idx_author_time` 和 `idx_team_time` 进行查询合并。
    

## 7. 缓存建议 (Redis)

-   **随机列表缓存**：`home:random:{user_id}`，TTL 1800s。
    
-   **热榜列表**：`home:top`，TTL 60s。
<!--stackedit_data:
eyJoaXN0b3J5IjpbMTg0ODUwNTY1XX0=
-->