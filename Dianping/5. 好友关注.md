# 共同关注
在数据库中用Set存储每个用户所有的关注对象，key是当前用户id，value是所有关注对象的id，查询两个用户的共同关注可以取两个Set的交集

# 关注推送（Feed流）

### 拉模式（读扩散）
用户发送笔记时将笔记存入发件箱，当用户读自己的收件箱时将自己关注的所有用户的发件箱的内容拉取到自己的收件箱中，读完后可以清理收件箱。
- 优点：省内存
- 缺点：延迟（一个用户关注了大量的用户）
![输入图片说明](/imgs/2025-04-15/5AQMkiBCmr1VhTMD.png)

### 推模式（写扩散）
不存在发件箱，用户发笔记的时候，直接将笔记推送到所有关注该用户的收件箱中
缺点：耗内存
![输入图片说明](/imgs/2025-04-15/XyQsmDd7pRLU90D1.png)

### 推拉结合
![输入图片说明](/imgs/2025-04-15/WPpfQnrTGRfoVTud.png)
普通人发笔记，直接推到其关注者的收件箱中
大V发笔记，先发送到自己的发件箱和活跃粉丝的收件箱中，普通粉丝想看的时候再从发件箱中拉取消息


# Redis实现收件箱
使用SortedSet结构，因为需要实现滚动分页的功能（每次分页查询后记录最后一条查到的消息LastId，下次从这个id开始查询，避免过程中新的数据插入对分页查询造成影响）
<!--stackedit_data:
eyJoaXN0b3J5IjpbLTEzMDM3MTE2MTEsLTkwNTk3NjM0OCwtMT
g5MTU3ODk0NCwtMTg3NDUxNjY1NSwtNzg3MjI3OTA4XX0=
-->